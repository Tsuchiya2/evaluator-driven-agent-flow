# Phase 5: Code Review Gate

**Purpose**: Verify code quality, security, completeness, and project standards compliance
**Gate Criteria**: All 8 evaluators must score â‰¥ 8.0/10.0 + UI verification (if frontend changed)

> **IMPORTANT**: The `standards-compliance-evaluator` is an **INDEPENDENT GATE** that cannot be bypassed.
> Even if all 7 code evaluators pass, Phase 5 fails if standards compliance fails.

---

## ðŸ“¥ Input from Phase 4 (Implementation)

- **Implementation Code**: All source code generated by 4 workers
  - Database: Models, migrations, schemas
  - Backend: APIs, services, business logic
  - Frontend: UI components, pages, state management
  - Test: Unit tests, integration tests
- **`.steering/{YYYY-MM-DD}-{feature-slug}/tasks.md`** - Completed task plan (all [x])
- **`.steering/{YYYY-MM-DD}-{feature-slug}/reports/phase4-quality-gate.md`** - Quality gate report (lint + tests passed)
- **`.steering/{YYYY-MM-DD}-{feature-slug}/design.md`** - Design document (reference)

---

## Workflow

### Step 1: Launch All Code Evaluators (PARALLEL)

**CRITICAL: All 8 evaluators must run in parallel (7 code evaluators + 1 standards compliance)**

```typescript
// Update status
await bash('.claude/scripts/update-edaf-phase.sh "Phase 5: Code Review" "Running 8 evaluators"')

// Launch all evaluators in parallel
const evaluators = [
  'code-quality-evaluator-v1-self-adapting',
  'code-testing-evaluator-v1-self-adapting',
  'code-security-evaluator-v1-self-adapting',
  'code-documentation-evaluator-v1-self-adapting',
  'code-maintainability-evaluator-v1-self-adapting',
  'code-performance-evaluator-v1-self-adapting',
  'code-implementation-alignment-evaluator-v1-self-adapting',
  'standards-compliance-evaluator'  // INDEPENDENT GATE - must pass separately
]

const evaluationPromises = evaluators.map(evaluator =>
  Task({
    subagent_type: evaluator,
    prompt: `Evaluate the code implementation for feature: {feature-slug}

Reference documents:
- Design: .steering/{YYYY-MM-DD}-{feature-slug}/design.md
- Task Plan: .steering/{YYYY-MM-DD}-{feature-slug}/tasks.md

Provide:
1. Score (0-10)
2. Findings (positive and negative)
3. Specific issues with file:line references
4. Recommendations for improvement
5. Pass/Fail determination (â‰¥7.0 = Pass)`
  })
)

const results = await Promise.all(evaluationPromises)
```

### Step 2: Review Results

```typescript
// Check all evaluators passed
const scores = results.map(r => parseScore(r))
const allPassed = scores.every(s => s >= 8.0)
const passCount = scores.filter(s => s >= 8.0).length

// IMPORTANT: standards-compliance-evaluator is an INDEPENDENT GATE
// Even if 7/8 pass, if standards fails, Phase 5 fails
const standardsResult = results.find(r => r.evaluator === 'standards-compliance-evaluator')
const standardsPassed = parseScore(standardsResult) >= 8.0

await bash(`.claude/scripts/update-edaf-phase.sh "Phase 5: Code Review" "${passCount}/8 evaluators passed"`)
```

### Step 3: Fix Issues (if needed)

```typescript
if (!allPassed) {
  // Collect issues from failed evaluators
  const failedEvaluators = results.filter(r => parseScore(r) < 7.0)
  const issues = failedEvaluators.flatMap(r => r.issues)

  console.log('âš ï¸  Code issues found:')
  for (const issue of issues) {
    console.log(`  - ${issue.file}:${issue.line} - ${issue.message}`)
  }

  // Fix issues directly (main agent or worker)
  // Then re-run evaluators

  // Update status
  await bash('.claude/scripts/update-edaf-phase.sh "Phase 4: Code Review" "Fixing issues"')
}
```

### Step 4: UI Verification (if frontend changed)

**CRITICAL: Only required when frontend files were modified**

```typescript
// Check if frontend files were modified
const frontendPatterns = [
  '**/components/**/*',
  '**/pages/**/*',
  '**/views/**/*',
  '**/*.css', '**/*.scss',
  '**/src/**/*.{tsx,jsx,ts,js,vue,svelte}'
]

const frontendModified = await checkFilesModified(frontendPatterns)

if (frontendModified) {
  await bash('.claude/scripts/update-edaf-phase.sh "Phase 4: Code Review" "UI Verification"')

  // Launch UI verification worker
  const uiResult = await Task({
    subagent_type: 'ui-verification-worker',
    prompt: `Perform UI/UX verification for feature: {feature-slug}

Reference documents:
- Design: .steering/{YYYY-MM-DD}-{feature-slug}/design.md
- Task Plan: .steering/{YYYY-MM-DD}-{feature-slug}/tasks.md

Requirements:
1. Verify all modified pages visually
2. Capture screenshots for evidence
3. Test interactive elements
4. Check browser console for errors
5. Generate verification report

Save report to: .steering/{YYYY-MM-DD}-{feature-slug}/reports/phase4-ui-verification.md
Save screenshots to: .steering/{YYYY-MM-DD}-{feature-slug}/screenshots/`
  })

  // Check UI verification result
  if (uiResult.status === 'skipped') {
    console.log('âš ï¸  UI verification skipped (WSL2 environment)')
    console.log('   Manual verification recommended')
  } else if (uiResult.status === 'passed') {
    console.log('âœ… UI verification passed')
  } else {
    console.log('âŒ UI verification failed')
    // Show issues and fix
  }
}
```

### Step 5: Run Verification Script

```bash
bash .claude/scripts/verify-ui.sh {feature-slug}
```

---

## Code Evaluators Detail

| Evaluator | Focus Area | Key Checks |
|-----------|------------|------------|
| quality | Code style | Linting, formatting, type safety |
| testing | Test coverage | Unit tests, coverage >80% |
| security | Vulnerabilities | OWASP Top 10, secrets, injection |
| documentation | Code docs | JSDoc, README, comments |
| maintainability | Complexity | Cyclomatic complexity, SOLID |
| performance | Efficiency | N+1 queries, memory, algorithms |
| implementation-alignment | Requirements | Matches design, all features |
| **standards-compliance** | **Project Standards** | **Skills rules, evidence required** |

### Standards Compliance Evaluator (Independent Gate)

The `standards-compliance-evaluator` is different from other evaluators:

- **Single Responsibility**: Only checks project standards from `.claude/skills/*-standards/SKILL.md`
- **Independent Gate**: Must pass regardless of other evaluators (cannot be compensated by high scores elsewhere)
- **Evidence Required**: Must quote rules verbatim, show check methods, list violations with file:line
- **Scoring**: Base 10.0, deductions for Critical (-1.0), Major (-0.5), Minor (-0.2) violations
- **Pass Threshold**: â‰¥ 8.0/10 (same as other evaluators)

---

## Issue Categories

### Critical (Must Fix)
- Security vulnerabilities
- Missing authentication/authorization
- Data validation failures
- Breaking changes

### High (Should Fix)
- Poor test coverage (<80%)
- Performance issues
- Missing error handling
- Type safety issues

### Medium (Consider Fixing)
- Code duplication
- Complex functions
- Missing documentation
- Inconsistent naming

### Low (Optional)
- Style inconsistencies
- Minor refactoring opportunities
- Comment improvements

---

## ðŸ“¤ Output to Phase 6 (Documentation)

After Phase 5 completion:

1. **Reviewed & Fixed Code**: All issues resolved
   - Code quality verified (â‰¥ 8.0/10 from all 8 evaluators)
   - Standards compliance verified (independent gate passed)
   - Security validated, documentation complete
   - Implementation aligns with design
2. **Evaluation Reports**: From each code evaluator (8 reports total)
3. **UI Verification Report** (if frontend changed): `.steering/{YYYY-MM-DD}-{feature-slug}/reports/phase5-ui-verification.md`
4. **Screenshots** (if frontend changed): `.steering/{YYYY-MM-DD}-{feature-slug}/screenshots/`

**Input for Phase 6**: All code ready for documentation updates

---

## Transition to Phase 6

When all evaluators pass AND UI verification passes:

```typescript
await bash('.claude/scripts/update-edaf-phase.sh "Phase 5: Code Review" "Complete"')
await bash('.claude/scripts/notification.sh "Phase 5 code review passed" WarblerSong')

// Proceed to Phase 6: Documentation
// Reference: PHASE6-DOCUMENTATION.md
```
